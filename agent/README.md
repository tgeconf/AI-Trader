# Agent模块

## 概述

Agent模块是AI-Trader系统的核心组件，负责实现基于AI的自动化交易决策和执行。该模块采用机构级架构设计，集成了多种先进的AI技术和风险管理策略。

## 模块结构

```
agent/
├── base_agent/
│   └── base_agent.py      # 基础Agent类，提供核心功能
└── README.md              # 本文件
```

## 核心组件

### BaseAgent类

`BaseAgent` 是系统的基础Agent类，封装了交易Agent的核心功能：

#### 主要功能

1. **MCP工具管理**
   - 连接和管理多个MCP服务（数学计算、搜索、交易、价格获取）
   - 动态加载和配置工具
   - 工具状态监控和故障恢复

2. **AI Agent创建与配置**
   - 基于LangChain框架创建智能Agent
   - 支持多种AI模型（OpenAI、Claude等）
   - 动态系统提示词生成

3. **交易执行与决策循环**
   - 多步骤推理决策机制
   - 重试和容错处理
   - 实时交易执行

4. **日志与管理**
   - 结构化日志记录
   - 交易历史追踪
   - 性能监控

5. **头寸与配置管理**
   - 投资组合头寸管理
   - 风险控制配置
   - 资金管理

#### 关键技术特性

- **多模型支持**：支持多种AI模型，可根据需求灵活切换
- **风险管理集成**：内置VaR模型、头寸规模计算、止损管理
- **容错机制**：多层重试和异常处理
- **实时监控**：系统状态和交易活动实时监控

#### 初始化参数

```python
BaseAgent(
    signature="agent_name",      # Agent标识
    basemodel="gpt-4",          # 基础模型
    stock_symbols=[...],        # 股票代码列表
    mcp_config={...},           # MCP工具配置
    log_path="./data/agent_data", # 日志路径
    max_steps=10,               # 最大推理步骤
    max_retries=3,              # 最大重试次数
    initial_cash=10000.0,       # 初始资金
    init_date="2025-10-13"      # 初始化日期
)
```

#### 核心方法

1. **initialize()** - 初始化MCP客户端和AI模型
2. **run_trading_session(today_date)** - 执行单日交易会话
3. **run_date_range(init_date, end_date)** - 执行日期范围内的交易
4. **register_agent()** - 注册新Agent并创建初始头寸
5. **calculate_portfolio_risk()** - 计算投资组合风险指标
6. **calculate_position_size()** - 计算头寸规模
7. **check_stop_loss()** - 检查止损条件
8. **get_risk_report()** - 生成风险报告

#### 风险管理功能

- **VaR计算**：使用历史模拟法计算风险价值
- **头寸规模**：基于凯利公式和波动率调整
- **止损管理**：固定百分比和ATR止损策略
- **风险报告**：综合风险指标和暴露分析

#### 交易决策流程

1. **数据获取**：获取当前价格、头寸和市场信息
2. **AI分析**：使用AI模型分析市场状况
3. **工具调用**：调用各种分析工具辅助决策
4. **决策生成**：基于分析结果生成交易决策
5. **执行验证**：验证交易条件并执行
6. **结果记录**：记录交易结果和更新头寸

#### 日志系统

- **结构化日志**：JSON格式记录所有交易活动
- **时间戳追踪**：精确到毫秒的交易时间记录
- **错误追踪**：详细的错误和异常记录
- **性能指标**：交易执行时间和成功率统计

## 使用示例

```python
# 创建Agent实例
agent = BaseAgent(
    signature="quant_agent_001",
    basemodel="gpt-4",
    initial_cash=50000.0
)

# 初始化Agent
await agent.initialize()

# 执行交易
await agent.run_date_range("2025-10-01", "2025-10-31")

# 获取风险报告
risk_report = agent.get_risk_report()
```

## 配置说明

### 环境变量

- `OPENAI_API_BASE`：OpenAI API基础URL
- `MATH_HTTP_PORT`：数学工具服务端口
- `SEARCH_HTTP_PORT`：搜索工具服务端口
- `TRADE_HTTP_PORT`：交易工具服务端口
- `GETPRICE_HTTP_PORT`：价格获取工具服务端口

### 默认配置

- **股票池**：NASDAQ 100成分股
- **风险参数**：单笔交易最大风险2%，组合最大风险10%
- **交易时间**：工作日交易
- **重试机制**：最多3次重试，指数退避延迟

## 扩展性

Agent模块设计具有良好的扩展性：

- **插件化工具**：可轻松添加新的分析工具
- **多策略支持**：支持同时运行多个交易策略
- **自定义模型**：可集成自定义AI模型
- **风险框架**：可扩展的风险管理框架

## 性能优化

- **异步处理**：使用asyncio实现并发处理
- **内存管理**：优化的数据结构和缓存机制
- **网络优化**：连接池和请求批处理
- **计算优化**：向量化计算和并行处理

## 监控与调试

- **实时监控**：交易状态和系统健康实时监控
- **详细日志**：完整的操作日志和错误追踪
- **性能指标**：响应时间和成功率统计
- **调试工具**：内置调试和诊断功能
